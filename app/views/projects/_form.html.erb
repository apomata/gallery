<%= form_for(@project) do |f| %>

  <% if @project.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@project.errors.count, "error") %> prohibited this project from being saved:</h2>

      <ul>
      <% @project.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <%#store project in session for picture to use%>
<%session[:project] = @project.id%>

<script type="text/javascript">
  function resizepicturearea () {

    var thumbnaildiv = $('#thumbnaildiv');
    var thumbnailbar = $('#thumbnailbar');
    var addpicbutton =  $('#addpicbutton');
    var picdescpanelbody = $('#picdescpanelbody');
    var mainpic = $('#mainpic');

    var picheight = mainpic.outerHeight( true );
    var addpicbuttonheight = $('#addpicbutton').outerHeight( true );
    var header = $('#picdescpanelhead').outerHeight( true );
    var bodypadding = picdescpanelbody.css('padding-top').replace(/[^-\d\.]/g, '');

    thumbnailbar.height(picheight - addpicbuttonheight);

    addpicbutton.width( thumbnailbar.width() - (addpicbutton.css('padding-left').replace(/[^-\d\.]/g, '') *2))

    if($('picdescpanel').height > mainpic.height) {
      picdescpanelbody.height(picheight - (bodypadding*4));
      }
  }
</script>

<script type="text/javascript">
  function swappictures(imagesrc, description) {
    var mainpic = $('#mainpic');
    var picdescpanelbody = $('#picdescpanelbody');

    picdescpanelbody.html(description);
    mainpic.html(imagesrc);
  }
</script>

<%if @project.id%>
<script type="text/javascript">
  function removecreator() {
    var r = confirm("Are you sure you no longer with to be associated with this project?");
    if (r == true) {

      $.post('/ajax/creatorremove.json', {
             p: <%=@project.id%>
        }, function(data) {
             var output = data.result;
             alert(output);
             window.location.replace("<%=project_url(@project)%>");
        })
    }

  }
</script>
<%end%>

  <div class="col-xs-11 col-xs-offset-1 pull-left">
    <h1 class="turninline-block">
      <%= f.label :title %><br>
      <strong>
        <%= f.text_field :title %>
      </strong>
    </h1>
      <%= f.submit %>
  </div>

<div class="col-xs-7 col-xs-offset-1 container">
  <h3>
    <strong>Picture</strong>
  </h3>
  <div class="row">
    <div id="mainpic" class="col-xs-4">
      <% displayedpicture = @project.projectpictures.first%>
      <%if !displayedpicture.nil?%>
      <%= image_tag displayedpicture.picture.url(:medium), :class => 'fisrtpic img-responsive', :onload => 'resizepicturearea()'%>
      <%end%>
    </div>
    <div class="col-xs-4">

      <div id="picdescpanel" class="panel panel-default">
        <div id='picdescpanelhead' class="panel-heading">
          <h3 class="panel-title">Description</h3>
        </div>
        <div id='picdescpanelbody' class="panel-body scrollable">
          <%if !displayedpicture.nil?%>
            <%= displayedpicture.description %>
          <%end%>
        </div>
      </div>

    </div>
    <div id="thumbnaildiv" class="col-xs-4 panel panel-default">
      <!-- Button trigger modal -->

      <button id="addpicbutton" type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
        add picture
      </button>
      <br>

      <div id="update-container">
        <%=render partial: "projects/thumbnailbar", object: @project, as: "project"%>
      </div>
      <!--
      <ul id='thumbnailbar' class="list-group scrollable">
        <% @project.projectpictures.each do |projectpicture| %>
          <li class="list-group-item">
            <%= image_tag projectpicture.picture.url(:thumb),
            :onclick => "swappictures( '#{image_tag projectpicture.picture.url(:medium), :class => 'fisrtpic', :onload => 'resizepicturearea()'}', '#{projectpicture.description}')"%>
          </li>
        <%end%>
      </ul>
      -->
    </div>
  </div>
  <br>
  <br>

  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Embedcode</h3>
    </div>
    <div class="panel-body">
      <%= f.text_area :embedcode, :class => "form_control col-xs-12", :rows => '3' %>
  </div>

  </div>
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Description</h3>
    </div>
    <div class="panel-body">
      <%= f.text_area :description, :class => "form_control col-xs-12", :rows => '15' %>
    </div>
  </div>

  <div class="panel panel-primary">
    <div class="panel-heading">
      <h3 class="panel-title">Special Links</h3>
    </div>
    <div class="panel-body">
      <ul class="list-group">
        <%# @project.profiles.each do |profile| %>
          <li class="list-group-item">
            links will go here
          </li>
        <%#end%>
      </ul>
    </div>
  </div>
</div>


<div class="col-xs-3 col-xs-offset-1 container">
  <div class="panel panel-primary">
    <div class="panel-heading">
      <h3 class="panel-title">Creators</h3>
    </div>
    <div class="panel-body">
      <ul class="list-group">
        <% @project.profiles.each do |profile| %>
          <li class="list-group-item">
            <%= image_tag profile.avatar.url(:thumb)%>
            <%= link_to profile.first_name, profile_path(profile)%>
            <%if current_user == profile%>
              <%= link_to 'Destroy', @project, method: :delete, data: { confirm: 'Are you sure?' } %>
              <button type="button" onclick="removecreator()">Remove from project</button>
            <%end%>
          </li>
        <%end%>
      </ul>
    </div>
  </div>
  <div class="panel panel-primary">
    <div class="panel-heading">
      <h3 class="panel-title">Other projects by the creators</h3>
    </div>
    <div class="panel-body">
      <ul class="list-group">
        <%projects = otherprojects%>
        <% projects.keys.each do |project| %>
          <li class="list-group-item">
            <% pic = project.projectpictures.first%>
            <% if !pic.nil? && !pic.picture.nil? %>
              <%= image_tag pic.picture.url(:thumb)%>
            <%end%>
            <%= link_to "#{project.title}", project_path(project)%>
          </li>
        <%end%>
      </ul>
    </div>
  </div>
</div>

<% end %>


<script type="text/javascript">

  //$(document).ready(
    function addpic() {

      alert($("#pictureinput").val());

      $.post('/ajax/picadd.json', {
        p: 1,
        picture: $("#pictureinput").val(),
        description: $("#descriptioninput").val()
      }, function(data) {
        var output = data.result;
        alert(output);
      });
  }

</script>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">Modal title</h4>
      </div>
      <div class="modal-body">

      <%pic = Projectpicture.new%>
        <%#= form_for(pic, remote: true, :authenticity_token => true, :html => {:id => "pictureform"}) do |p| %>
        <%#= form_for(pic, :url => url_for(:controller => 'projects', :action => 'createpic'), remote: true, :authenticity_token => true, :html => {:id => "pictureform"}) do |p| %>
        <%= form_for(@project, format: 'js', :url => url_for(:controller => 'projects', :action => 'createpic'), remote: true, :authenticity_token => true, :html => {:id => "pictureform"}) do |p| %>
          <%= hidden_field_tag :id, @project.id %>
                  <h4>
                    <strong>Picture</strong>
                  </h4>
          <%= p.file_field :picture, id: "pictureinput" %>
          <br>
          <h4>
            <strong>Picture Description</strong>
          </h4>
          <%= p.text_area :description, :class => "form_control col-xs-12 custom-control", :rows => '10', :id => "descriptioninput"%>
          <%#= p.submit :id => "submitbutton"%>
          <%=p.submit "Save", :disable_with=>"Loading..."%>
        <%end%>

      <%= form_tag({:action => 'preview'}, :format => 'js', :remote => true, :'data-update-target' => 'update-container', :authenticity_token => true) do %>
           <%= hidden_field_tag :id, @project.id %>
                  <h4>
                    <strong>Picture</strong>
                  </h4>
          <%= file_field :projectpicture, :picture %>
          <br>
          <h4>
            <strong>Picture Description</strong>
          </h4>
          <%= text_area :description, :class => "form_control col-xs-12 custom-control", :rows => '10', :id => "descriptioninput"%>
          <%= submit_tag 'Submit', :disable_with => 'Please wait...', :class => 'submit' %>

      <% end %>

    </div>
      <div class="modal-footer">
        <br>
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>
